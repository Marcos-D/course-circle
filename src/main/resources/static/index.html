<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CourseCircle Student</title>
  <style>
    :root { --bg:#f7f8fb; --panel:#fff; --border:#e1e4ea; --accent:#0d6efd; --muted:#667085; --text:#1f2933; }
    body { margin:0; font-family: "Segoe UI", Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:20px 24px; background:linear-gradient(135deg, #0d6efd, #3e8aff); color:#fff; }
    .header-top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1 { margin:0 0 6px; }
    header p { margin:0; color:#e7edff; }
    main { max-width:900px; margin: -32px auto 32px; padding:0 16px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); }
    .stack { display:flex; gap:16px; flex-wrap:wrap; }
    .field { flex:1; min-width:220px; }
    label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; background:#fafbff; box-sizing:border-box; }
    input:focus, select:focus { outline:none; border-color:#94b5ff; box-shadow:0 0 0 3px rgba(13,110,253,0.15); background:#fff; }
    button.primary { background:var(--accent); color:#fff; border:none; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 6px 14px rgba(13,110,253,0.3); }
    button.secondary { background:#eef2ff; color:#1d3b8b; border:none; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; box-shadow:none; }
    .timer { font-size:36px; font-weight:700; letter-spacing:1px; margin:12px 0; }
    .muted { color:var(--muted); font-size:13px; }
    .log { margin-top:20px; background:#0f172a; color:#e2e8f0; padding:14px; border-radius:10px; min-height:160px; max-height:220px; white-space:pre-wrap; overflow:auto; font-size:13px; }
    .section { margin-top:16px; }
    .pill { border-radius:999px; padding:10px 16px; }
    .auth-status { display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px dashed var(--border); border-radius:10px; background:#f8faff; }
    .auth-dot { width:10px; height:10px; border-radius:50%; background:#e11d48; display:inline-block; }
    .auth-dot.active { background:#22c55e; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.6); display:flex; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#fff; border-radius:12px; padding:20px; width:100%; max-width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.25); position:relative; }
    .modal h2 { margin-top:0; margin-bottom:8px; }
    .modal .muted { margin-top:0; margin-bottom:16px; }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
    .modal-close { position:absolute; top:10px; right:10px; border:none; background:transparent; font-size:18px; cursor:pointer; color:#475569; }
    .modal .stack { flex-direction:column; }
    .auth-message { margin-top:10px; padding:10px 12px; border-radius:8px; font-size:13px; }
    .auth-message.success { background:#ecfdf3; color:#166534; border:1px solid #bbf7d0; }
    .auth-message.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .auth-helper { font-size:12px; color:#64748b; margin-top:6px; }
    .auth-switch { margin-top:12px; font-size:13px; color:#64748b; text-align:center; }
    .auth-link { color:#0d6efd; font-weight:600; cursor:pointer; }
    .session-warning { color:#b45309; font-weight:600; }
    .focus-status { display:flex; align-items:center; gap:8px; margin-top:8px; font-size:13px; }
    .focus-dot { width:10px; height:10px; border-radius:50%; background:#f59e0b; display:inline-block; }
    .focus-dot.active { background:#22c55e; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div>
        <h1>CourseCircle - Student</h1>
        <p>Start a study session, track time, and upload notes.</p>
      </div>
      <button class="secondary pill" id="btn-open-auth">Login / Register</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="auth-status">
        <span class="auth-dot" id="authDot"></span>
        <span id="authStatus">Not authenticated.</span>
        <button class="secondary pill" id="btn-logout" style="margin-left:auto;">Logout</button>
      </div>

      <div class="stack">
        <div class="field">
          <label for="courseSelect">Select course</label>
          <select id="courseSelect"></select>
          <button class="secondary pill" id="btn-refresh-courses" style="margin-top:8px;">Refresh courses</button>
        </div>
      </div>

      <div class="section">
        <div class="muted">Session controls</div>
        <div class="timer" id="timer">00:00:00</div>
        <div class="focus-status">
          <span class="focus-dot" id="focusDot"></span>
          <span id="focusStatus">Focus: unknown</span>
        </div>
        <div class="stack">
          <button class="primary" id="btn-start">Start studying</button>
          <button class="secondary" id="btn-end" disabled>End session</button>
        </div>
        <p class="muted" id="sessionStatus">No active session.</p>
      </div>

      <div class="section">
        <div class="muted">Upload notes / slides</div>
        <div class="stack">
          <input type="file" id="fileInput" />
          <button class="secondary" id="btn-upload">Upload</button>
        </div>
      </div>

      <div class="section">
        <div class="muted">Attention tracking</div>
        <p class="muted">We log focus/blur or visibility changes below so you can spot context switches.</p>
      </div>

      <div class="log" id="log"></div>
    </div>
  </main>

  <div id="authModal" class="modal-backdrop hidden">
    <div class="modal">
      <button class="modal-close" id="btn-close-auth">x</button>
      <h2 id="authTitle">Welcome back</h2>
      <p class="muted" id="authSubtitle">Sign in to start sessions and upload files.</p>
      <div class="stack">
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="student@example.edu" />
        </div>
        <div class="field" id="displayNameField">
          <label for="displayName">Display name</label>
          <input id="displayName" type="text" placeholder="Sample Student" />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Choose a password" />
          <div class="auth-helper" id="authHelper">Minimum 6 characters.</div>
        </div>
      </div>
      <div id="authMessage" class="auth-message hidden"></div>
      <div class="modal-actions">
        <button class="secondary pill" id="btn-login">Login</button>
        <button class="primary pill" id="btn-register">Register</button>
      </div>
      <div class="auth-switch" id="authSwitch">
        New here? <span class="auth-link" id="link-register">Create an account</span>
      </div>
    </div>
  </div>

<script>
  const timerEl = document.getElementById('timer');
  const statusEl = document.getElementById('sessionStatus');
  const logEl = document.getElementById('log');
  const authStatusEl = document.getElementById('authStatus');
  const authDotEl = document.getElementById('authDot');
  const authModal = document.getElementById('authModal');
  const focusDotEl = document.getElementById('focusDot');
  const focusStatusEl = document.getElementById('focusStatus');
  const courseSelectEl = document.getElementById('courseSelect');
  const headerAuthButton = document.getElementById('btn-open-auth');
  const logoutButton = document.getElementById('btn-logout');
  const displayNameField = document.getElementById('displayNameField');
  const authTitle = document.getElementById('authTitle');
  const authSubtitle = document.getElementById('authSubtitle');
  const authHelper = document.getElementById('authHelper');
  const authMessage = document.getElementById('authMessage');
  const authSwitch = document.getElementById('authSwitch');
  const loginButton = document.getElementById('btn-login');
  const registerButton = document.getElementById('btn-register');
  let timerInterval = null;
  let startTime = null;
  let accumulatedMs = 0;
  let activeSessionId = null;
  let authToken = localStorage.getItem('cc_jwt') || null;
  let seededCourses = false;

  updateAuthStatus();
  setAuthMode('login');

  function log(message, data) {
    const ts = new Date().toLocaleTimeString();
    const line = data !== undefined ? `${message} ${JSON.stringify(data)}` : message;
    logEl.textContent += `[${ts}] ${line}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function formatDuration(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const seconds = String(totalSeconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
  }

  function startTimer() {
    startTime = Date.now();
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const elapsed = accumulatedMs + (Date.now() - startTime);
      timerEl.textContent = formatDuration(elapsed);
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  function pauseTimer() {
    if (timerInterval && startTime) {
      accumulatedMs += Date.now() - startTime;
      stopTimer();
    }
  }

  function resumeTimerIfActive() {
    if (activeSessionId) {
      startTime = Date.now();
      startTimer();
    }
  }

  async function callApi(path, options) {
    try {
      const headers = options?.headers ? { ...options.headers } : {};
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      const res = await fetch(path, options ? { ...options, headers } : { headers });
      const contentType = res.headers.get('content-type') || '';
      const body = contentType.includes('application/json') ? await res.json() : await res.text();
      log(`${options?.method || 'GET'} ${path} (${res.status})`, body);
      if (res.status === 401) {
        showAuthModal();
      }
      return { ok: res.ok, status: res.status, body };
    } catch (err) {
      log(`${options?.method || 'GET'} ${path} (error)`, err.message);
      return { ok: false, status: 0, body: err.message };
    }
  }

  function updateAuthStatus() {
    if (authToken) {
      authStatusEl.textContent = 'Authenticated (token stored locally).';
      authDotEl.classList.add('active');
      headerAuthButton.classList.add('hidden');
      logoutButton.classList.remove('hidden');
    } else {
      authStatusEl.textContent = 'Not authenticated.';
      authDotEl.classList.remove('active');
      headerAuthButton.classList.remove('hidden');
      logoutButton.classList.add('hidden');
    }
  }

  function showAuthModal() {
    authModal.classList.remove('hidden');
    setAuthMode('login');
  }

  function hideAuthModal() {
    authModal.classList.add('hidden');
  }

  function setAuthMode(mode) {
    const isRegister = mode === 'register';
    displayNameField.classList.toggle('hidden', !isRegister);
    authTitle.textContent = isRegister ? 'Create your account' : 'Welcome back';
    authSubtitle.textContent = isRegister
      ? 'Create an account to start sessions and upload files.'
      : 'Sign in to start sessions and upload files.';
    authHelper.textContent = isRegister ? 'Minimum 6 characters.' : 'Enter your password to sign in.';
    authMessage.classList.add('hidden');
    authMessage.textContent = '';
    authSwitch.innerHTML = isRegister
      ? 'Already have an account? <span class="auth-link" id="link-login">Sign in</span>'
      : 'New here? <span class="auth-link" id="link-register">Create an account</span>';
    const swapLink = document.getElementById(isRegister ? 'link-login' : 'link-register');
    swapLink.addEventListener('click', () => setAuthMode(isRegister ? 'login' : 'register'));
    loginButton.classList.toggle('hidden', isRegister);
    registerButton.classList.toggle('hidden', !isRegister);
  }

  async function fetchCourses() {
    const resp = await callApi('/api/courses');
    if (!resp.ok || !Array.isArray(resp.body)) {
      courseSelectEl.innerHTML = '<option value="">Login to load courses</option>';
      return;
    }
    if (resp.body.length === 0 && authToken && !seededCourses) {
      await seedSampleCourses();
      return;
    }
    courseSelectEl.innerHTML = '<option value="">Select a course</option>';
    resp.body.forEach((course) => {
      const option = document.createElement('option');
      option.value = course.id;
      option.textContent = `${course.code} - ${course.name}${course.term ? ' (' + course.term + ')' : ''}`;
      courseSelectEl.appendChild(option);
    });
  }

  async function seedSampleCourses() {
    if (seededCourses) {
      return;
    }
    seededCourses = true;
    const samples = [
      { code: 'CSE8A', name: 'Introduction to Programming I (Java)', term: 'Fall 2025' },
      { code: 'CSE11', name: 'Introduction to Programming II', term: 'Winter 2026' },
      { code: 'CSE12', name: 'Basic Data Structures & OO Design', term: 'Fall 2025' },
      { code: 'CSE30', name: 'Computer Organization & Systems Programming', term: 'Spring 2026' },
      { code: 'CSE100', name: 'Advanced Data Structures', term: 'Spring 2026' },
      { code: 'CSE101', name: 'Design & Analysis of Algorithms', term: 'Spring 2026' },
      { code: 'CSE110', name: 'Software Engineering', term: 'Winter 2026' },
      { code: 'CSE120', name: 'Operating Systems', term: 'Fall 2025' },
      { code: 'CSE140', name: 'Digital Systems Components & Design', term: 'Winter 2026' }
    ];
    for (const course of samples) {
      await callApi('/api/courses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(course)
      });
    }
    await fetchCourses();
  }

  async function fetchActiveSession() {
    const resp = await callApi('/api/sessions/active');
    if (resp.status === 204 || !resp.ok || !resp.body || !resp.body.id) {
      await fallbackFetchActiveSession();
      return;
    }
    activeSessionId = resp.body.id;
    const startedAt = resp.body.startedAt ? Date.parse(resp.body.startedAt) : null;
    if (startedAt) {
      accumulatedMs = Date.now() - startedAt;
      timerEl.textContent = formatDuration(accumulatedMs);
    }
    if (resp.body.courseId) {
      courseSelectEl.value = String(resp.body.courseId);
    }
    statusEl.textContent = `Active session for course ${resp.body.courseId} (id ${activeSessionId})`;
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-end').disabled = false;
    startTimer();
  }

  async function fallbackFetchActiveSession() {
    const resp = await callApi('/api/sessions');
    if (!resp.ok || !Array.isArray(resp.body)) {
      resetSessionUi();
      return;
    }
    const active = resp.body.find((session) => !session.endedAt);
    if (!active || !active.id) {
      resetSessionUi();
      return;
    }
    activeSessionId = active.id;
    const startedAt = active.startedAt ? Date.parse(active.startedAt) : null;
    if (startedAt) {
      accumulatedMs = Date.now() - startedAt;
      timerEl.textContent = formatDuration(accumulatedMs);
    }
    if (active.courseId) {
      courseSelectEl.value = String(active.courseId);
    }
    statusEl.textContent = `Active session for course ${active.courseId} (id ${activeSessionId})`;
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-end').disabled = false;
    startTimer();
  }

  function resetSessionUi() {
    activeSessionId = null;
    stopTimer();
    accumulatedMs = 0;
    timerEl.textContent = '00:00:00';
    statusEl.textContent = 'No active session.';
    statusEl.classList.remove('session-warning');
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-end').disabled = true;
  }

  document.getElementById('btn-start').addEventListener('click', async () => {
    const courseId = Number(courseSelectEl.value);
    if (!courseId) {
      log('startSession', 'Provide a course ID');
      statusEl.textContent = 'Select a course before starting.';
      statusEl.classList.add('session-warning');
      return;
    }
    statusEl.classList.remove('session-warning');
    const resp = await callApi('/api/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId })
    });
    if (resp.status === 409) {
      log('startSession', 'Active session found. Resuming it now.');
      await fetchActiveSession();
      return;
    }
    if (resp.ok) {
      activeSessionId = resp.body.id;
      statusEl.textContent = `Active session for course ${courseId} (id ${activeSessionId})`;
      document.getElementById('btn-start').disabled = true;
      document.getElementById('btn-end').disabled = false;
      accumulatedMs = 0;
      startTimer();
    }
  });

  document.getElementById('btn-end').addEventListener('click', async () => {
    if (!activeSessionId) {
      log('endSession', 'No active session to end');
      return;
    }
    const resp = await callApi(`/api/sessions/${activeSessionId}/end`, { method: 'PATCH' });
    if (resp.ok) {
      statusEl.textContent = 'No active session.';
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-end').disabled = true;
      accumulatedMs = 0;
      stopTimer();
      timerEl.textContent = '00:00:00';
      activeSessionId = null;
    }
  });

  document.getElementById('btn-upload').addEventListener('click', async () => {
    const courseId = Number(courseSelectEl.value);
    const fileInput = document.getElementById('fileInput');
    if (!courseId) {
      log('uploadFile', 'Provide a course ID');
      return;
    }
    if (!fileInput.files.length) {
      log('uploadFile', 'Choose a file first');
      return;
    }
    const form = new FormData();
    form.append('file', fileInput.files[0]);
    await callApi(`/api/courses/${courseId}/files`, {
      method: 'POST',
      body: form
    });
  });

  function handleVisibilityChange() {
    const state = document.visibilityState;
    log('visibilitychange', state);
    if (state === 'hidden') {
      pauseTimer();
      focusStatusEl.textContent = 'Focus: hidden';
      focusDotEl.classList.remove('active');
    } else if (state === 'visible') {
      resumeTimerIfActive();
      focusStatusEl.textContent = 'Focus: visible';
      focusDotEl.classList.add('active');
    }
  }

  function handleFocus() {
    log('focus');
    resumeTimerIfActive();
    focusStatusEl.textContent = 'Focus: focused';
    focusDotEl.classList.add('active');
  }

  function handleBlur() {
    log('blur');
    pauseTimer();
    focusStatusEl.textContent = 'Focus: blurred';
    focusDotEl.classList.remove('active');
  }

  registerButton.addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const displayName = document.getElementById('displayName').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password || !displayName) {
      log('register', 'Email, display name, and password are required');
      return;
    }
    const resp = await callApi('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, displayName, role: 'STUDENT' })
    });
    if (resp.ok && resp.body.token) {
      authToken = resp.body.token;
      localStorage.setItem('cc_jwt', authToken);
      updateAuthStatus();
      fetchCourses();
      fetchActiveSession();
      authMessage.className = 'auth-message success';
      authMessage.textContent = 'Account created. You are signed in.';
      authMessage.classList.remove('hidden');
      log('auth', 'Registered and signed in');
      setTimeout(hideAuthModal, 800);
    }
    if (!resp.ok) {
      authMessage.className = 'auth-message error';
      authMessage.textContent = 'Registration failed. Try a different email.';
      authMessage.classList.remove('hidden');
    }
  });

  loginButton.addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      log('login', 'Email and password are required');
      return;
    }
    const resp = await callApi('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    if (resp.ok && resp.body.token) {
      authToken = resp.body.token;
      localStorage.setItem('cc_jwt', authToken);
      updateAuthStatus();
      fetchCourses();
      fetchActiveSession();
      authMessage.className = 'auth-message success';
      authMessage.textContent = 'Signed in successfully.';
      authMessage.classList.remove('hidden');
      log('auth', 'Signed in');
      setTimeout(hideAuthModal, 800);
    }
    if (!resp.ok) {
      authMessage.className = 'auth-message error';
      authMessage.textContent = 'Login failed. Check your email and password.';
      authMessage.classList.remove('hidden');
    }
  });

  logoutButton.addEventListener('click', async () => {
    await callApi('/api/sessions/end-all', { method: 'POST' });
    authToken = null;
    localStorage.removeItem('cc_jwt');
    updateAuthStatus();
    log('logout', 'Token cleared locally');
    activeSessionId = null;
    stopTimer();
    timerEl.textContent = '00:00:00';
    statusEl.textContent = 'No active session.';
    statusEl.classList.remove('session-warning');
    fetchCourses();
  });

  document.getElementById('btn-open-auth').addEventListener('click', showAuthModal);
  document.getElementById('btn-close-auth').addEventListener('click', hideAuthModal);
  document.getElementById('btn-refresh-courses').addEventListener('click', fetchCourses);

  document.addEventListener('visibilitychange', handleVisibilityChange);
  window.addEventListener('focus', handleFocus);
  window.addEventListener('blur', handleBlur);

  log('Student dashboard loaded. Provide a course ID to begin.');
  focusStatusEl.textContent = document.hasFocus() ? 'Focus: focused' : 'Focus: blurred';
  focusDotEl.classList.toggle('active', document.hasFocus());
  fetchCourses();
  if (authToken) {
    fetchActiveSession();
  }
</script>
</body>
</html>
